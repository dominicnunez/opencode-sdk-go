# Audit Exceptions

> Items validated as false positives or accepted as won't-fix.
> Managed by willie audit loop. Do not edit format manually.
>
> Entry format:
> ### Plain language description
> **Location:** `file/path:line` — optional context
> **Date:** YYYY-MM-DD
> **Reason:** Explanation (can be multiple lines)

## False Positives

<!-- Findings where the audit misread the code or described behavior that doesn't occur -->

### GetBody error explicitly ignored in request body setup

**Location:** `internal/requestconfig/requestconfig.go:402,409`
**Date:** 2026-02-22

**Reason:** The GetBody closures at lines 401 and 405 are defined inline and cannot fail:
- Line 401 returns `io.NopCloser(bytes.NewReader(b)), nil` which always has nil error
- Line 408 calls `body.Seek(0, 0)` on a `*bytes.Reader` which cannot fail

The comparison to line 459 (where error is handled) is misleading because that's in the retry loop where GetBody could be any function, not the inline closures defined here.

### Magic numbers in retry delay calculation

**Location:** `internal/requestconfig/requestconfig.go:29-33`
**Date:** 2026-02-22

**Reason:** The values `maxRetryDelay = 8 * time.Second`, `initialDelayMultiplier = 0.5`, and `jitterDivisor = 4` are named constants with clear semantic names, not magic numbers. The audit conflates "lacks explanatory comment" with "magic number" - these are different concerns. Named constants are the standard solution for magic numbers.

### Redundant nil check in interface type assertion

**Location:** `option/requestoption.go:64-70`
**Date:** 2026-02-22

**Reason:** The audit title is factually incorrect - `if c, ok := client.(*http.Client); ok` is a type assertion, not a nil check. The "stale state" concern (else branch not clearing HTTPClient) doesn't affect behavior because `requestconfig.go:419-422` checks `if cfg.CustomHTTPDoer != nil` first, giving CustomHTTPDoer precedence. The code is consistent in practice.

## Won't Fix

<!-- Real findings not worth fixing — architectural cost, external constraints, etc. -->

### Named return values with naked returns in generated service code

**Location:** `client.go:47`, `config.go:34`, `agent.go:31`, `session.go:36` and similar patterns in other service files
**Date:** 2026-02-22

**Reason:** These files are auto-generated by the Stainless OpenAPI code generator. The named return values combined with naked returns are a stylistic choice of the generator. Modifying the generated code would require changing the Stainless generator template, which is an external tool. The pattern, while not idiomatic, does not cause bugs in practice for these simple factory functions.

### Path parameters not URL-encoded in generated service methods

**Location:** `session.go:58,78,90,102,114,126,138,154,166,178,190,202,214,226,238,250` and similar patterns in other service files
**Date:** 2026-02-22

**Reason:** These files are auto-generated by the Stainless OpenAPI code generator. Adding `url.PathEscape()` would require modifying the generator template, which is an external tool. The session IDs in this SDK are server-generated UUIDs that do not contain special characters, so path injection is not a practical concern for normal usage.

### httputil dump errors ignored in debugging methods

**Location:** `internal/apierror/apierror.go:44,46,51`
**Date:** 2026-02-22

**Reason:** The DumpRequest and DumpResponse methods are debugging utilities that return []byte. Adding error return values would be a breaking API change. For debugging purposes, returning empty output when the dump fails is acceptable behavior—the caller can inspect the returned bytes to determine if useful information was captured. Adding logging in library code is not idiomatic Go.

### http.DefaultClient used without default timeout

**Location:** `internal/requestconfig/requestconfig.go:174`
**Date:** 2026-02-22

**Reason:** The SDK intentionally uses http.DefaultClient as the default to give users full control over timeout behavior. Setting a default timeout could break existing code that relies on indefinite waits for long-running operations. Users can set a timeout via WithRequestTimeout(), WithHTTPClient(), or by passing a context with deadline. Documenting this is preferable to changing the default.

### Panic in library code can crash applications

**Location:** `internal/apijson/decoder.go:211`, `internal/apijson/field.go:30`, `internal/apiquery/encoder.go:190,235,246`, `option/requestoption.go:101`
**Date:** 2026-02-22

**Reason:** This SDK is auto-generated from an OpenAPI spec by Stainless. The panics in generated code occur in edge cases that should never happen in normal usage (union type not in registry, invalid map keys, unsupported array formats). Replacing these panics with error returns would require modifying the Stainless generator, which is an external tool. The `WithMaxRetries` panic is documented in the function's docstring.

### Deprecated config fields still parsed

**Location:** `config.go:53-54,68,73-74,1058`
**Date:** 2026-02-22

**Reason:** The Config struct and its deprecated fields (autoshare, mode, layout) are generated from the OpenAPI spec. We cannot control what fields the spec defines. The deprecation comments are accurate and users should migrate, but removing the fields would break the generated code contract with the API.

### Global sync.Map for encoder/decoder caching grows unbounded

**Location:** `internal/apijson/decoder.go:18`, `internal/apijson/encoder.go:19`, `internal/apiquery/encoder.go:15`
**Date:** 2026-02-22

**Reason:** This is a standard caching pattern for reflection-based serialization. The cache is bounded by the number of distinct types used, which in practice is limited and stable for a given application. Memory profiling would be needed to demonstrate an actual problem before adding complexity like LRU eviction.

## Intentional Design Decisions

<!-- Findings that describe behavior which is correct by design -->

### Hardcoded default base URL uses localhost

**Location:** `option/requestoption.go:266`
**Date:** 2026-02-22

**Reason:** This SDK is designed for local development against the opencode CLI server which runs on localhost:54321 by default. Users targeting a production API should explicitly set the base URL using `WithBaseURL()`. The function name `WithEnvironmentProduction` is misleading (it should perhaps be `WithEnvironmentLocal`), but changing it now would be a breaking change.

### Debug middleware logs sensitive data

**Location:** `option/middleware.go:23-33`
**Date:** 2026-02-22

**Reason:** The `WithDebugLog` function is explicitly documented as "for debugging and development purposes only" and "should not be used in production." Users must explicitly opt-in by passing this middleware. Adding header redaction would add complexity for a debugging tool and could hide issues that debugging is meant to reveal.

### SSE stream error not returned directly

**Location:** `event.go:42-51`
**Date:** 2026-02-22

**Reason:** This is a standard pattern for streaming APIs in Go. The stream object must be returned so callers can iterate over events, and embedding the initial connection error in the stream allows a single return signature. The pattern is documented and callers are expected to check `stream.Err()` before iteration, similar to how database rows work.
